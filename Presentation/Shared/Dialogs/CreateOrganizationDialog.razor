@using Domain;

<MudDialog>
    <TitleContent>
        Create Organization
    </TitleContent>
    <DialogContent>
        <MudStack Class="gap-2">
            <MudTextField @bind-Value="Model.OrganizationName" Label="Name" Variant="Variant.Outlined" ShrinkLabel></MudTextField>
            <MudTextField @bind-Value="Model.Description" Label="Description" Variant="Variant.Outlined" ShrinkLabel></MudTextField>
            <MudSelect T="Enums.OrganizationType"
                       @bind-Value="Model.OrganizationType"
                       Variant="Variant.Outlined"
                       Label="Type">
                @foreach (Enums.OrganizationType type in Enum.GetValues(typeof(Enums.OrganizationType)))
                {
                    <MudSelectItem Value="type">@type</MudSelectItem>
                }
            </MudSelect>
            <MudAutocomplete T="ApplicationUserModel"
                             @bind-Value="Model.User"
                             Label="Assign" 
                Variant="Variant.Outlined" 
                ShrinkLabel 
                SearchFunc="SearchUser"
                ToStringFunc="@((s) => s.Name)">
            </MudAutocomplete>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" Variant="Variant.Filled">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }

    [Parameter] public MyOrganizationModel Model { get; set; } = new();

    [Parameter] public Enums.Action Action { get; set; }

    private List<ApplicationUserModel> Users = new();

    private void Cancel() => MudDialog.Cancel();

    protected override async Task OnInitializedAsync()
    {
        Users = await _userService.GetAllUsers();
        Users = Users.Where(u => u.ProfileInformation is not null).ToList();
    }

    private Task<IEnumerable<ApplicationUserModel>> SearchUser(string value, CancellationToken cancellationToken)
    {
        IEnumerable<ApplicationUserModel> result;

        if (string.IsNullOrWhiteSpace(value))
            result = Users;
        else
            result = Users.Where(x => x.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase));

        return Task.FromResult(result);
    }

    private async Task Submit()
    {
        Model.Id = Model.User?.Id;

        if(Action == Enums.Action.Create)
            await _organizationService.CreateOrganizationAsync(Model);
        else
            await _organizationService.UpdateOrganizationAsync(Model);

        MudDialog.Close(DialogResult.Ok(true));
    }
}
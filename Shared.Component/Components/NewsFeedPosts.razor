@using Domain
@using Domain.Models
@using Humanizer
@using Microsoft.JSInterop
@using Service
@using Service.Interfaces
@using Shared.Component.Extensions

@inject IJSRuntime JSRuntime

<MudStack Class="mt-2" Style="width: 100%;">
    @foreach(var context in filterPost)
    {

        <MudPaper Elevation="2" Class="pa-1">
            <MudStack AlignItems="AlignItems.Center" Row>
                <MudAvatar Size="Size.Medium" Class="profile position-relative" Variant="Variant.Filled" Style="border : 1px solid #d3d3d3;">
                    <MudImage Src="@context.MyOrganization?.ProfilePicture"></MudImage>
                </MudAvatar>
                <MudStack Class="gap-0 pa-0" Spacing="0">
                    <MudText Typo="Typo.caption"><b>@context.MyOrganization?.OrganizationName</b></MudText>
                    <small>@context.CreatedAt.ToString("MM/dd/yyyy hh:mm tt")</small>
                </MudStack>
            </MudStack>
            <MudStack>

                <MudText Typo="Typo.body2" Class="mb-3">
                    @context.Message
                </MudText>

                @if (context.Images != null && context.Images.Any())
                {
                    <FeedImageGallery Images="@context.Images" />
                }

                <MudStack Justify="Justify.SpaceBetween" Row>
                    <div>
                        @if (context.Likes is not null)
                        {

                            var reactions = context.Likes;

                            foreach (var item in reactions.DistinctBy(c => c.LikeType).Take(3) ?? [])
                            {
                                <span class="display-reaction">@item.LikeType.ToEmoji()</span>
                            }

                            <span style="font-size: 14px;">  @(reactions.Count == 0 ? "" : reactions.Count)</span>
                        }
                    </div>
                    <div>
                        @if (context.Comments is not null)
                        {
                            <spanstyle style="font-size: 14px;">@context.Comments.Count Comments</spanstyle>

                        }

                    </div>
                </MudStack>
            </MudStack>

            <MudDivider Class="my-2" />
            <MudStack Justify="Justify.SpaceAround" Row>
                <MudMenu @bind-Open="context.openEmoji" AnchorOrigin="Origin.TopCenter" TransformOrigin="Origin.BottomCenter">
                    <ActivatorContent>

                        @if (context.Likes is not null)
                        {
                            @if (context.Likes.Any(l => l.UserId == appStateService.CurrentUser.Id))
                            {
                                <MudButton StartIcon="@Icons.Material.Filled.ThumbUp"
                                           Variant="Variant.Text"
                                           Size="Size.Small"
                                           Color="Color.Primary">Like</MudButton>
                            }
                            else
                            {
                                <MudButton StartIcon="@Icons.Material.Filled.ThumbUp"
                                           Variant="Variant.Text"
                                           Size="Size.Small"
                                           Color="Color.Default">Like</MudButton>
                            }
                        }
                        else
                        {
                            <MudButton StartIcon="@Icons.Material.Filled.ThumbUp"
                                       Variant="Variant.Text"
                                       Size="Size.Small"
                                       Color="Color.Default">Like</MudButton>
                        }
                    </ActivatorContent>
                    <ChildContent>
                        <MudStack Class="pa-2" Row>
                            <span class="reaction" @onclick="() => HandleLike(Enums.LikeType.Like, context)">👍</span>
                            <span class="reaction" @onclick="() => HandleLike(Enums.LikeType.Heart, context)">❤️</span>
                            <span class="reaction" @onclick="() => HandleLike(Enums.LikeType.Funny, context)">😆</span>
                            <span class="reaction" @onclick="() => HandleLike(Enums.LikeType.Wow, context)">😮</span>
                            <span class="reaction" @onclick="() => HandleLike(Enums.LikeType.Cry, context)">😢</span>
                            <span class="reaction" @onclick="() => HandleLike(Enums.LikeType.Angry, context)">😠</span>
                        </MudStack>
                    </ChildContent>
                </MudMenu>
                <MudButton StartIcon="@Icons.Material.Filled.Comment"
                           OnClick="()=> OpenComment(context)"
                           Variant="Variant.Text"
                           Size="Size.Small"
                           Color="Color.Default">
                    Comment
                </MudButton>
            </MudStack>
        </MudPaper>
   
    }

    <div class="d-flex justify-center align-items-center" id="post-loader" style="height: 40px;">
        @if (isLoadingMore)
        {
            <MudProgressCircular id="post-loader" Size="Size.Small" Color="Color.Primary" Indeterminate></MudProgressCircular>
        }
    </div>

</MudStack>




<MudDrawer Class="comment-drawer" @bind-Open="@_openComments" Height="70vh" Anchor="@Anchor.Bottom" Elevation="1" Variant="@DrawerVariant.Temporary">
   <MudStack AlignItems="AlignItems.Center" Class="mb-3">
        <MudButton OnClick="() => _openComments = !_openComments" Class="comment-btn" Color="Color.Primary" Variant="Variant.Filled"></MudButton> 
   </MudStack>
    @foreach (var comment in listComments.Where( c => c.ParentCommentId is null))
    {
        <MudStack Spacing="0" StretchItems="StretchItems.All">
            <CommentComponent @key="comment.NewsFeedCommentId" User="comment.User" Comment="comment" OnReplyClick="(e) => Reply(e.Item1, e.Item2)" AllComments="listComments"></CommentComponent>
        </MudStack>
    }
    @if(_openComments) {
       <MudPaper Class="position-absolute d-flex flex-column justiy-content-end comment-input px-2" Square Elevation="1">
            <div style="position:relative;">
                @if (!string.IsNullOrEmpty(replyTo))
                {
                    <MudChip T="string" Color="Color.Primary"
                             Variant="Variant.Filled"
                             OnClose="ResetComment"
                             Size="Size.Small"
                             Style="position:absolute; left:0px; top:43%; transform:translateY(-50%); z-index:10;">
                        Replying to @replyTo.Truncate(6)
                    </MudChip>
                }

                <MudTextField @ref="_commentRef"
                              @bind-Value="_comment"
                              Placeholder="Type your comment here"
                              Margin="Margin.Dense"
                              Variant="Variant.Outlined"
                              Class="@(string.IsNullOrEmpty(replyTo) ? string.Empty : "chip-input-padding")"
                              Clearable
                              Lines="0"
                              MaxLines="4" />
            </div>
            <MudStack AlignItems="AlignItems.End" Style="width: 100%">
                <MudButton OnClick="AddComment" Size="Size.Small" Variant="Variant.Text">Send</MudButton>
           </MudStack>
        
       </MudPaper>
   }
</MudDrawer>

<MudOverlay @bind-Visible="_openComments" LockScroll></MudOverlay>
@code {
    [Inject] AppStateService appStateService { get; set; } = null!;
    [Inject] ICommentService commentService { get; set; } = null!;
    [Inject] IUserService UserService { get; set; } = null!;

    [Parameter] public Guid? OrganiationId { get; set; }
    [Parameter] public INewsFeedService NewsFeedService { get; set; } = null!;

    private MudDataGrid<NewsFeedModel>? _dataGrid;
    private bool _openComments;
    private string _comment = string.Empty;
    private MudTextField<string>? _commentRef;
    private NewsFeedCommentModel _newsFeedCommentModel = new();
    private Guid _newsFeedId;
    private Guid? _commentParentId;
    private List<NewsFeedCommentModel> listComments = new();
    private List<NewsFeedModel> _listPost = new();
    private List<NewsFeedModel> filterPost = new();
    private bool isInViewPort = false;

    private int PageNumber = 0;

    private string replyTo = string.Empty;

    private bool isLoadingMore = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadMorePosts();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (firstRender)
        {
            await JSRuntime.InvokeAsync<object>("setupIntersectionObserver", "post-loader", DotNetObjectReference.Create(this));
        }

        _commentRef?.FocusAsync();
    }

    [JSInvokable]
    public async Task OnElementVisible()
    {
        await LoadMorePosts();
    }

    private async Task LoadMorePosts()
    {
        if (isLoadingMore)
            return;

        isLoadingMore = true;

        StateHasChanged();

        var result = await NewsFeedService.GetNewsFeeds(new PaginationRequestModel
        {
            Count = 3,
            StartIndex = _listPost.Count,
        });

        _listPost.AddRange(result?.Records ?? []);

        filterPost = [.._listPost];

        isLoadingMore = false;

        _dataGrid?.ReloadServerData();

        await InvokeAsync(StateHasChanged);
    }

    public void filterPostsByOrganization(Guid? organizationId, bool? loadAll = false)
    {
        if(loadAll?? false)
            filterPost = _listPost;
        else
            filterPost = _listPost.Where(p => p.MyOrganization?.MyOrganizationId == organizationId).ToList();

    }

    private async Task HandleLike(Enums.LikeType likeType, NewsFeedModel model)
    {
        LikeModel like = new LikeModel
        {
            LikeType = likeType,
            UserId = appStateService.CurrentUser.Id,
            NewsFeedId = model.NewsFeedId,
            Emoji = likeType.ToEmoji()
        };

        var result = await NewsFeedService.UpdateLike(like);

        if(result.LikeId == new Guid()) {

            model.Likes?.RemoveAll( l => l.Emoji == result.Emoji);

            model.openEmoji = false;

            await InvokeAsync(StateHasChanged);

            return;
        }

        model.Likes ??= [];

        var current = model.Likes.FirstOrDefault(c => c.LikeId == result.LikeId);

        if (current is not null)
            model.Likes.Remove(current);

        model.Likes.Add(result);

        model.openEmoji = false;

        await InvokeAsync(StateHasChanged);
    }

    private async Task OpenComment(NewsFeedModel model)
    {
        _openComments = !_openComments;
        _newsFeedId = model.NewsFeedId;

        listComments = await commentService.GetCommentsByNewsFeedIdAsync(model.NewsFeedId);

        foreach (var comment in listComments)
        {
            comment.User = await UserService.GetUserById(comment.Id);
        }
    }

    private void Reply(Guid? parentGuid, string? replyto)
    {
        _commentParentId = parentGuid;

        replyTo = replyto?? string.Empty;
    }

    private async Task AddComment()
    {
        if(string.IsNullOrWhiteSpace(_comment))
            return;

        _newsFeedCommentModel.Id = appStateService.CurrentUser.Id;
        _newsFeedCommentModel.Message = _comment;
        _newsFeedCommentModel.ParentCommentId = _commentParentId;
        _newsFeedCommentModel.NewsFeedId = _newsFeedId;

        var result = await commentService.AddCommentAsync(_newsFeedCommentModel);

        result.User = await UserService.GetUserById(result.Id);

        listComments.Add(result);

        //Reset
        ResetComment();

    }

    private void ResetComment()
    {
        _comment = string.Empty;
        _newsFeedCommentModel = new();
        _commentParentId = null;
        replyTo = string.Empty;
    }
}

<style>
    .mud-table-cell {
        padding: 4px !important;
    }

    .mud-table-cell:before {
        padding: unset !important;
    }

    .comment-drawer {
        border-top-right-radius: 14px;
        border-top-left-radius: 14px;
        padding: 8px;
    
    }
    .comment-btn {
        padding: unset !important;
        height: 6px !important;
        width: 20%;
    }

    .comment-input {
        bottom: 0;
        right: 0;
        left: 0;
        z-index: 20;
    }

    td.row-loading:nth-of-type(n+2),
    td:has(td.row-loading:nth-of-type(n+2)) {
        display: none !important;
    }

    .reaction {
        cursor: pointer;
        font-size: 20px;
    }

        .reaction:hover {
            transform: scale(1.2);
        }

    .display-reaction:nth-of-type(n+2) {
        margin-left: -8px;
    }

    .chip-input-padding input {
        padding-left: 150px !important; /* Adjust based on chip width */
    }

    .comment-input-wrapper {
        flex-shrink: 0;
        padding: 12px;
        background-color: #fff;
        border-top: 1px solid #e0e0e0;
        position: relative;
        z-index: 20;
        width: 100%;
        box-sizing: border-box;
    }

    .sticky-bottom {
        position: sticky;
        bottom: env(safe-area-inset-bottom, 0);
        background: white;
        z-index: 9999;
        /* Optional: Add spacing when keyboard appears */
        padding-bottom: env(safe-area-inset-bottom, 0);
    }
</style>
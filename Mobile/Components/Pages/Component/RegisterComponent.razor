
<style>
    .register-container {
        background-color: #FBF8FF;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 2rem 1.5rem;
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 24px;
        padding: 2rem;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(63, 81, 181, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .brand-title {
        background: linear-gradient(135deg, #3F51B5 0%, #9C27B0 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 800;
        font-size: 2.25rem;
        letter-spacing: -1px;
        margin-bottom: 0.5rem;
        text-align: center;
    }

    .brand-subtitle {
        color: #7E57C2;
        font-size: 0.9rem;
        text-align: center;
        margin-bottom: 2rem;
        font-weight: 400;
        opacity: 0.8;
    }

    .modern-input {
        border-radius: 16px !important;
        background-color: #F5F3F9 !important;
    }

    .modern-input fieldset {
        border: none !important;
    }

    .primary-gradient-button {
        background: linear-gradient(135deg, #3F51B5 0%, #9C27B0 100%) !important;
        border-radius: 16px !important;
        padding: 14px !important;
        color: white !important;
        font-weight: 600 !important;
        text-transform: none !important;
        letter-spacing: 0.5px !important;
        box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3) !important;
        transition: transform 0.2s ease, box-shadow 0.2s ease !important;
    }

    .primary-gradient-button:active {
        transform: scale(0.98);
    }

    .back-link {
        color: #3F51B5 !important;
        font-weight: 600 !important;
        text-decoration: none !important;
    }
</style>

<div class="register-container">
    <div class="brand-title">CampusConnect</div>
    <div class="brand-subtitle">Join our digital ecosystem.</div>

    <div class="glass-card">
        <MudStack Spacing="3">
            <MudTextField @bind-Value="User.Name" Label="Full Name" Variant="Variant.Outlined" Margin="Margin.Dense" Class="modern-input" FullWidth="true" />
            <MudTextField @bind-Value="User.Email" Label="Email" Variant="Variant.Outlined" Margin="Margin.Dense" Class="modern-input" FullWidth="true" />
            <MudTextField @bind-Value="User.Password" Label="Password" Variant="Variant.Outlined" InputType="InputType.Password" Margin="Margin.Dense" Class="modern-input" FullWidth="true" />
            <MudTextField @bind-Value="confirmPassword" Label="Confirm Password" Variant="Variant.Outlined" InputType="InputType.Password" Margin="Margin.Dense" Class="modern-input" FullWidth="true" />

            <MudSelect T="MyOrganizationModel" Text="@User?.ProfileInformation?.MyOrganization?.OrganizationName" @bind-Value="User!.ProfileInformation!.MyOrganization" Label="Department" Variant="Variant.Outlined" Margin="Margin.Dense" Class="modern-input" FullWidth="true">
                @foreach (var org in Organizations)
                {
                    <MudSelectItem Value="org">@org.OrganizationName</MudSelectItem>
                }
            </MudSelect>

            <MudButton 
                Class="primary-gradient-button mt-4"
                Variant="Variant.Filled" 
                Size="Size.Large" 
                OnClick="Register"
                FullWidth="true">
                @if (isLoading)
                {
                    <MudProgressCircular Size="Size.Small" Color="Color.Inherit" Indeterminate="true" Class="mr-2" />
                    <span>Creating account...</span>
                }
                else
                {
                    <span>Register</span>
                }
            </MudButton>
        </MudStack>
    </div>

    <MudText Typo="Typo.body2" Class="mt-8 text-center" Style="color: #757575;">
        Already part of the hub? 
        <MudLink OnClick="OnBack" Class="back-link ml-1">Sign in</MudLink>
    </MudText>
</div>

@code {
    [Parameter] public EventCallback OnBack { get; set; }

    private ApplicationUserModel User = new();
    private bool isLoading = false;
    private string confirmPassword = string.Empty;
    private List<MyOrganizationModel> Organizations = new();

    protected override async Task OnInitializedAsync()
    {
        User.ProfileInformation = new();
        User.ProfileInformation.MyOrganization = new();

        Organizations = await _organizationService.GetAllOrganizationsAsync();

        Organizations = Organizations.Where(o => o.OrganizationType is Domain.Enums.OrganizationType.Department).ToList();
    }

    private async Task Register()
    {
        var validations = ModelValidator.Validate(User);
        if (validations.Any())
        {
            SnackBarHelper.ShowSnackbar("All fields are required!", Variant.Filled, _snackBar, Severity.Error);
            return;
        }

        if (!confirmPassword.Equals(User.Password, StringComparison.InvariantCultureIgnoreCase))
        {
            SnackBarHelper.ShowSnackbar("Passwords do not match", Variant.Filled, _snackBar, Severity.Error);
            return;
        }

        try
        {
            isLoading = true;

            User.ProfileInformation!.MyOrganizationId = User.ProfileInformation.MyOrganization!.MyOrganizationId;
            User.ProfileInformation.FullName = User.Name;

            var result = await _userService.CreateUser(User);

            if(result.IsSuccess)
            {
                SnackBarHelper.ShowSnackbar("Account created successfully!", Variant.Filled, _snackBar, Severity.Success);
                Back();
            } else
            {
                throw new Exception(result.Error.Description);
            }
        }
        catch (Exception ex)
        {
            SnackBarHelper.ShowSnackbar(ex.Message, Variant.Filled, _snackBar, Severity.Error);
        }
        finally
        {
            isLoading = false;
        }

    }

    private void Back() => OnBack.InvokeAsync();
}
